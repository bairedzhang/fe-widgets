function atFriends(a){this.elem=a.elem,this.at={},this.url=a.url,this.index=0}$(function(){var a={elem:$("#textarea1")[0],url:"http://suggestion.baidu.com/su?&zxmode=1&json=1&p=3&sid=&cb=?&wd="},b={elem:$("#textarea2")[0],url:"http://suggestion.baidu.com/su?&zxmode=1&json=1&p=3&sid=&cb=?&wd="},c=new atFriends(a);c.init();var d=new atFriends(b);d.init()}),atFriends.prototype={init:function(){0!=$("#tWarp").length&&$("#tWarp").remove();var a=$("body"),b=$('<div id="tWarp"></div>');a.append(b);var c=$(this.elem).offset().left+"px",d=$(this.elem).offset().top+"px",e=$(this.elem).width()+"px",f=$(this.elem).height()+"px",g=$(this.elem).css("line-height"),h="position:absolute;overflow:hidden;white-space:pre-wrap;z-index:-9999;word-wrap:break-word;word-break:break-all;line-height:"+g+";width:"+e+";height:"+f+";left:"+c+";top:"+d;b.attr("style",h),this.inset()},inset:function(){var a=this;$("#tipAt").delegate("li","click",function(){a.hiddenTip();var b=$(this).text();a.add(a.elem,b,a.at.pos,a.at.len),a.hiddenTip()}),$(this.elem).keyup(function(){a.getAt()})},getCursor:function(){var a=this,b={start:0,end:0,text:""};if("number"==typeof a.elem.selectionStart)b.start=a.elem.selectionStart,b.end=a.elem.selectionEnd,b.text=a.elem.value.substring(0,this.elem.selectionStart);else if(document.selection){var c=document.selection.createRange(),d=document.body.createTextRange();d.moveToElementText(a.elem),b.text=c.text,b.bookmark=c.getBookmark();for(var e=0;d.compareEndPoints("StartToStart",c)<0&&0!==c.moveStart("character",-1);e++)"\r"==this.elem.value.charAt(e)&&e++;b.start=e,b.end=b.text.length+b.start,b.text=a.elem.value.substring(0,e)}return b},setCursor:function(a,b,c){if(this.elem.setSelectionRange)this.elem.setSelectionRange(b,c);else if(this.elem.createRange){var d=this.elem.createRange();this.elem.value.length==rangeData.start?(d.collapse(!1),d.select()):(d.moveToBookmark(rangeData.bookmark),d.select())}},add:function(a,b,c,d){this.elem.focus();var e;if(this.elem.setSelectionRange){_tValue=this.elem.value;var f=c-d,g=f+b.length,h=_tValue.substring(0,f)+"@"+b+" "+_tValue.substring(c,this.elem.value.length);this.elem.value=h,this.setCursor(this.elem,g+2,g+2)}else this.elem.createTextRange&&(e=document.selection.createRange(),e.moveStart("character",-d),e.text="@"+b+" ")},checkLocation:function(){0!=$("#tWarp").length&&$("#tWarp").remove();var a=$("body"),b=$('<div id="tWarp"></div>');a.append(b);var c=$(this.elem).offset().left+"px",d=$(this.elem).offset().top+"px",e=$(this.elem).width()+"px",f=$(this.elem).height()+"px",g=$(this.elem).css("line-height"),h="position:absolute;overflow:hidden;white-space:pre-wrap;z-index:-9999;word-wrap:break-word;word-break:break-all;line-height:"+g+";width:"+e+";height:"+f+";left:"+c+";top:"+d;b.attr("style",h)},getAt:function(){this.checkLocation();var a=this.getCursor(),b=_value=a.text.replace(/\r/g,""),c=/@[^@]{1,20}$/g;if(_value.indexOf("@")>=0&&_value.match(c)){{var d=a.start,e=_value.match(c)[0];new RegExp("^"+e+".*$","m")}_value_value=_value.slice(0,d),/^@[a-zA-Z0-9\u4e00-\u9fa5_]*$/.test(e)&&!/\s/.test(e)||""==e?(this.at.m=_oValue_oValue=e.slice(1),this.at.l=_value.slice(0,-e.length),this.at.r=b.slice(d-e.length,b.length),this.at.pos=d,this.at.len=e.length,this.showTip(this.url)):this.hiddenTip()}else this.hiddenTip()},buidTip:function(){var a=this;$("#tWarp").empty();var b="  "+this.at.l+"<cite>@</cite>"+this.at.r;$("#tWarp").html(b);var c=$("#tWarp cite").offset().left+"px",d=$("#tWarp cite").offset().top+parseInt($("#tWarp").css("line-height"))+5+"px";if(parseInt(d)>parseInt($("#tWarp").offset().top+$("#tWarp").height())&&(d=$("#tWarp").offset().top+$("#tWarp").height()+5+"px"),document.all){var e=$(document).scrollTop(),f=this.getInputPositon(this.elem);c=f.left+"px",d=f.bottom+e+"px"}$("#tipAt").css({left:c,top:d,display:"block"});var g=$("#tipAt").find("li").eq(0);g.addClass("li_on"),$(a.elem).unbind("keyup").bind("keydown",function(b){return a.keyMove(b)}),a.hover()},hiddenTip:function(){$("#tipAt").css("display","none"),$("#tipAt li").unbind("click,mouseover")},keyMove:function(a){var b=this,c=a.keyCode,d=$("#tipAt li").length;switch(c){case 40:return b.index++,b.index>=d&&(b.index=0),b.keyMoveTo(b.index),!1;case 38:return b.index--,b.index<0&&(b.index=d-1),b.keyMoveTo(b.index),!1;case 13:var e=$(".li_on").text();return b.add(b.elem,e,b.at.pos,b.at.len),b.hiddenTip(),b.keyHandler(),!1}b.keyHandler()},keyHandler:function(){var a=this;a.index=0,$(a.elem).unbind("keydown").bind("keyup",function(){a.getAt()})},keyMoveTo:function(a){$("#tipAt li").removeClass("li_on").eq(a).addClass("li_on")},hover:function(){var a=this;$("#tipAt").delegate("li","mouseover",function(){a.index=$(this).index(),$(this).addClass("hover").siblings().removeClass("li_on hover")}),$("#tipAt").delegate("li","mouseout",function(){$(this).removeClass("hover")})},showTip:function(a){$("#tipAt").empty(),a+=encodeURIComponent(this.at.m),$.getJSON(a,function(a){a=a.s;var b="";if(a.length>0){var c=Math.min(10,a.length);if(b='<li class="li_on">'+a[0]+"</li>",c>1)for(var d=1;c>d;d++)b=b+"<li>"+a[d]+"</li>";$("#tipAt").append(b)}},"json"),this.buidTip()},getInputPositon:function(a){if(document.selection){a.focus();var b=document.selection.createRange();return{left:b.boundingLeft,top:b.boundingTop,bottom:b.boundingTop+b.boundingHeight}}}};